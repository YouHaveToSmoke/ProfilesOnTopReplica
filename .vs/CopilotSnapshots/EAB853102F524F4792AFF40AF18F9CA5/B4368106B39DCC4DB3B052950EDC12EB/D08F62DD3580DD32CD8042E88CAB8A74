using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Windows.Forms;

namespace OnTopReplica.Forms {
    
    internal class SaveAllInstancesDialog : Form {
        
        private Label lblInfo;
        private Label lblProfileName;
        private TextBox txtProfileName;
        private Panel pnlInstances;
        private Button btnOK;
        private Button btnCancel;

        public class InstanceConfiguration {
            internal MainForm Instance { get; set; }
            public string RegionName { get; set; }
            public RegionAnchor RegionAnchor { get; set; }
            public bool ScaleWithSourceWindow { get; set; }
            internal TextBox NameTextBox { get; set; }
            internal ComboBox AnchorComboBox { get; set; }
            internal CheckBox ScaleCheckBox { get; set; }
        }

        private List<InstanceConfiguration> _configurations = new List<InstanceConfiguration>();

        public string ProfileName => txtProfileName.Text.Trim();

        public IReadOnlyList<InstanceConfiguration> InstanceConfigurations => _configurations.AsReadOnly();

        internal SaveAllInstancesDialog(IEnumerable<MainForm> instances) {
            InitializeComponent(instances);
        }
        
        private void InitializeComponent(IEnumerable<MainForm> instances) {
            this.lblInfo = new Label();
            this.lblProfileName = new Label();
            this.txtProfileName = new TextBox();
            this.pnlInstances = new Panel();
            this.btnOK = new Button();
            this.btnCancel = new Button();
            
            this.SuspendLayout();
            
            // lblInfo
            this.lblInfo.AutoSize = true;
            this.lblInfo.Location = new Point(12, 9);
            this.lblInfo.Size = new Size(560, 26);
            this.lblInfo.Text = "Alle offenen OnTopReplica-Fenster werden als ein Profil mit mehreren Regionen gespeichert.\r\nGeben Sie für jede Region einen eindeutigen Namen ein.";
            
            // lblProfileName
            this.lblProfileName.AutoSize = true;
            this.lblProfileName.Location = new Point(12, 45);
            this.lblProfileName.Text = "Profilname:";
            
            // txtProfileName
            this.txtProfileName.Location = new Point(90, 42);
            this.txtProfileName.Size = new Size(482, 20);
            this.txtProfileName.TabIndex = 0;
            
            // pnlInstances
            this.pnlInstances.AutoScroll = true;
            this.pnlInstances.BorderStyle = BorderStyle.FixedSingle;
            this.pnlInstances.Location = new Point(12, 75);
            this.pnlInstances.Size = new Size(560, 340);
            this.pnlInstances.TabIndex = 1;
            
            // Create controls for each instance
            int yPos = 10;
            int instanceNumber = 1;
            
            foreach (var instance in instances) {
                var config = new InstanceConfiguration {
                    Instance = instance,
                    RegionName = $"Region {instanceNumber}"
                };
                
                // GroupBox for each instance
                var groupBox = new GroupBox();
                groupBox.Location = new Point(10, yPos);
                groupBox.Size = new Size(520, 150);
                groupBox.Text = GetInstanceDescription(instance, instanceNumber);
                groupBox.TabIndex = instanceNumber * 4;
                
                // Details label
                var lblDetails = new Label();
                lblDetails.AutoSize = false;
                lblDetails.Location = new Point(10, 20);
                lblDetails.Size = new Size(500, 35);
                lblDetails.Text = GetInstanceDetails(instance);
                lblDetails.Font = this.Font;
                groupBox.Controls.Add(lblDetails);
                
                // Region name label
                var lblName = new Label();
                lblName.AutoSize = true;
                lblName.Location = new Point(10, 55);
                lblName.Text = "Name für diese Region:";
                lblName.Font = this.Font;
                groupBox.Controls.Add(lblName);
                
                // Region name textbox
                var txtName = new TextBox();
                txtName.Location = new Point(110, 52);
                txtName.Size = new Size(390, 20);
                txtName.Text = config.RegionName;
                txtName.TabIndex = instanceNumber * 4 - 2;
                config.NameTextBox = txtName;
                groupBox.Controls.Add(txtName);
                
                // Anchor label
                var lblAnchor = new Label();
                lblAnchor.AutoSize = true;
                lblAnchor.Location = new Point(10, 85);
                lblAnchor.Text = "Region-Anker:";
                lblAnchor.Font = this.Font;
                groupBox.Controls.Add(lblAnchor);
                
                // Anchor combobox
                var cmbAnchor = new ComboBox();
                cmbAnchor.DropDownStyle = ComboBoxStyle.DropDownList;
                cmbAnchor.Location = new Point(110, 82);
                cmbAnchor.Size = new Size(150, 21);
                cmbAnchor.TabIndex = instanceNumber * 4 - 1;
                cmbAnchor.Font = this.Font;
                cmbAnchor.Items.AddRange(new object[] { "Oben Links", "Oben Rechts", "Unten Links", "Unten Rechts" });
                cmbAnchor.SelectedIndex = 0;
                config.AnchorComboBox = cmbAnchor;
                groupBox.Controls.Add(cmbAnchor);
                
                // Scale checkbox
                var chkScale = new CheckBox();
                chkScale.Location = new Point(10, 110);
                chkScale.Size = new Size(490, 30);
                chkScale.Text = "Fenstergröße mit Quell-Fenster-Auflösung skalieren";
                chkScale.TabIndex = instanceNumber * 4;
                chkScale.Font = this.Font;
                chkScale.Checked = false;
                config.ScaleCheckBox = chkScale;
                groupBox.Controls.Add(chkScale);
                
                pnlInstances.Controls.Add(groupBox);
                _configurations.Add(config);
                
                yPos += 170;
                instanceNumber++;
            }
            
            // btnOK
            this.btnOK.Location = new Point(416, 420);
            this.btnOK.Size = new Size(75, 23);
            this.btnOK.TabIndex = 1000;
            this.btnOK.Text = "OK";
            this.btnOK.UseVisualStyleBackColor = true;
            this.btnOK.Click += BtnOK_Click;
            
            // btnCancel
            this.btnCancel.DialogResult = DialogResult.Cancel;
            this.btnCancel.Location = new Point(497, 420);
            this.btnCancel.Size = new Size(75, 23);
            this.btnCancel.TabIndex = 1001;
            this.btnCancel.Text = "Abbrechen";
            this.btnCancel.UseVisualStyleBackColor = true;
            
            // SaveAllInstancesDialog
            this.AcceptButton = this.btnOK;
            this.CancelButton = this.btnCancel;
            this.ClientSize = new Size(584, 455);
            this.Controls.Add(this.lblInfo);
            this.Controls.Add(this.lblProfileName);
            this.Controls.Add(this.txtProfileName);
            this.Controls.Add(this.pnlInstances);
            this.Controls.Add(this.btnCancel);
            this.Controls.Add(this.btnOK);
            this.FormBorderStyle = FormBorderStyle.FixedDialog;
            this.MaximizeBox = false;
            this.MinimizeBox = false;
            this.StartPosition = FormStartPosition.CenterScreen;
            this.Text = "Alle Fenster als Profil speichern";
            
            this.ResumeLayout(false);
            this.PerformLayout();
        }
        
        private string GetInstanceDescription(MainForm instance, int number) {
            string windowTitle = "Kein Fenster";

            if (instance.CurrentThumbnailWindowHandle != null) {
                windowTitle = instance.CurrentThumbnailWindowHandle.Title;
                if (string.IsNullOrWhiteSpace(windowTitle)) {
                    windowTitle = instance.CurrentThumbnailWindowHandle.Class;
                }
                if (windowTitle.Length > 40) {
                    windowTitle = windowTitle.Substring(0, 37) + "...";
                }
            }

            return $"Fenster {number}: {windowTitle}";
        }

        private string GetInstanceDetails(MainForm instance) {
            var details = new System.Text.StringBuilder();

            // Position and size
            details.AppendLine($"Position: X={instance.Location.X}, Y={instance.Location.Y}  |  Größe: {instance.Size.Width}x{instance.Size.Height}");

            // Region info if any
            if (instance.SelectedThumbnailRegion != null) {
                var region = instance.SelectedThumbnailRegion;
                details.Append($"Region: {region.Bounds.Width}x{region.Bounds.Height} ");
                details.Append(region.Relative ? "(Relativ)" : "(Absolut)");
            } else {
                details.Append("Vollständiges Fenster (keine Region)");
            }

            return details.ToString();
        }
        
        private void BtnOK_Click(object sender, EventArgs e) {
            // Validate profile name
            if (string.IsNullOrWhiteSpace(txtProfileName.Text)) {
                MessageBox.Show(
                    "Bitte geben Sie einen Profilnamen ein.",
                    "Eingabe erforderlich",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Warning
                );
                txtProfileName.Focus();
                return;
            }
            
            // Update configurations with user input
            foreach (var config in _configurations) {
                config.RegionName = config.NameTextBox.Text.Trim();

                if (string.IsNullOrWhiteSpace(config.RegionName)) {
                    MessageBox.Show(
                        "Bitte geben Sie für jede Region einen Namen ein.",
                        "Eingabe erforderlich",
                        MessageBoxButtons.OK,
                        MessageBoxIcon.Warning
                    );
                    config.NameTextBox.Focus();
                    return;
                }

                // Map ComboBox selection to RegionAnchor
                switch (config.AnchorComboBox.SelectedIndex) {
                    case 0: config.RegionAnchor = RegionAnchor.TopLeft; break;
                    case 1: config.RegionAnchor = RegionAnchor.TopRight; break;
                    case 2: config.RegionAnchor = RegionAnchor.BottomLeft; break;
                    case 3: config.RegionAnchor = RegionAnchor.BottomRight; break;
                    default: config.RegionAnchor = RegionAnchor.TopLeft; break;
                }

                config.ScaleWithSourceWindow = config.ScaleCheckBox.Checked;
            }
            
            this.DialogResult = DialogResult.OK;
            this.Close();
        }
    }
}
