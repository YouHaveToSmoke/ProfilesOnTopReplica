using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Windows.Forms;

namespace OnTopReplica.Forms {

    /// <summary>
    /// Dialog for saving all open OnTopReplica instances as a profile.
    /// </summary>
    public class SaveAllInstancesDialog : Form {

        private Label lblInfo;
        private Label lblProfileName;
        private TextBox txtProfileName;
        private Panel pnlInstances;
        private Button btnOK;
        private Button btnCancel;

        public class InstanceConfiguration {
            internal MainForm Instance { get; set; }
            public string RegionName { get; set; }
            public RegionAnchor RegionAnchor { get; set; }
            public bool ScaleWithSourceWindow { get; set; }
            internal TextBox NameTextBox { get; set; }
            internal ComboBox AnchorComboBox { get; set; }
            internal CheckBox ScaleCheckBox { get; set; }
        }

        private List<InstanceConfiguration> _configurations = new List<InstanceConfiguration>();

        public string ProfileName => txtProfileName.Text.Trim();

        public IReadOnlyList<InstanceConfiguration> InstanceConfigurations => _configurations.AsReadOnly();

        internal SaveAllInstancesDialog(IEnumerable<MainForm> instances) {
            InitializeComponent(instances);
        }
        
        private void InitializeComponent(IEnumerable<MainForm> instances) {
            this.SuspendLayout();
            // 
            // SaveAllInstancesDialog
            // 
            this.ClientSize = new System.Drawing.Size(284, 261);
            this.Name = "SaveAllInstancesDialog";
            this.Load += new System.EventHandler(this.SaveAllInstancesDialog_Load);
            this.ResumeLayout(false);

        }
        
        private string GetInstanceDescription(MainForm instance, int number) {
            string windowTitle = "Kein Fenster";

            if (instance.CurrentThumbnailWindowHandle != null) {
                windowTitle = instance.CurrentThumbnailWindowHandle.Title;
                if (string.IsNullOrWhiteSpace(windowTitle)) {
                    windowTitle = instance.CurrentThumbnailWindowHandle.Class;
                }
                if (windowTitle.Length > 40) {
                    windowTitle = windowTitle.Substring(0, 37) + "...";
                }
            }

            return $"Fenster {number}: {windowTitle}";
        }

        private string GetInstanceDetails(MainForm instance) {
            var details = new System.Text.StringBuilder();

            // Position and size
            details.AppendLine($"Position: X={instance.Location.X}, Y={instance.Location.Y}  |  Größe: {instance.Size.Width}x{instance.Size.Height}");

            // Region info if any
            if (instance.SelectedThumbnailRegion != null) {
                var region = instance.SelectedThumbnailRegion;
                details.Append($"Region: {region.Bounds.Width}x{region.Bounds.Height} ");
                details.Append(region.Relative ? "(Relativ)" : "(Absolut)");
            } else {
                details.Append("Vollständiges Fenster (keine Region)");
            }

            return details.ToString();
        }

        private void FocusInstance(MainForm instance) {
            try {
                // Bring the window to front and flash it
                if (instance != null && !instance.IsDisposed) {
                    // Store original state
                    var originalOpacity = instance.Opacity;
                    var originalTopMost = instance.TopMost;

                    // Flash effect: make it more visible temporarily
                    instance.TopMost = true;
                    instance.BringToFront();
                    instance.Activate();

                    // Flash by changing opacity
                    var timer = new System.Windows.Forms.Timer();
                    int flashCount = 0;
                    timer.Interval = 150;
                    timer.Tick += (s, e) => {
                        flashCount++;
                        if (flashCount <= 6) {
                            instance.Opacity = (flashCount % 2 == 0) ? originalOpacity : Math.Max(0.3, originalOpacity - 0.4);
                        } else {
                            instance.Opacity = originalOpacity;
                            instance.TopMost = originalTopMost;
                            timer.Stop();
                            timer.Dispose();
                        }
                    };
                    timer.Start();
                }
            }
            catch {
                // Ignore errors if window is closed
            }
        }
        
        private void BtnOK_Click(object sender, EventArgs e) {
            // Validate profile name
            if (string.IsNullOrWhiteSpace(txtProfileName.Text)) {
                MessageBox.Show(
                    "Bitte geben Sie einen Profilnamen ein.",
                    "Eingabe erforderlich",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Warning
                );
                txtProfileName.Focus();
                return;
            }
            
            // Update configurations with user input
            foreach (var config in _configurations) {
                config.RegionName = config.NameTextBox.Text.Trim();

                if (string.IsNullOrWhiteSpace(config.RegionName)) {
                    MessageBox.Show(
                        "Bitte geben Sie für jede Region einen Namen ein.",
                        "Eingabe erforderlich",
                        MessageBoxButtons.OK,
                        MessageBoxIcon.Warning
                    );
                    config.NameTextBox.Focus();
                    return;
                }

                // Map ComboBox selection to RegionAnchor
                switch (config.AnchorComboBox.SelectedIndex) {
                    case 0: config.RegionAnchor = RegionAnchor.TopLeft; break;
                    case 1: config.RegionAnchor = RegionAnchor.TopRight; break;
                    case 2: config.RegionAnchor = RegionAnchor.BottomLeft; break;
                    case 3: config.RegionAnchor = RegionAnchor.BottomRight; break;
                    default: config.RegionAnchor = RegionAnchor.TopLeft; break;
                }

                config.ScaleWithSourceWindow = config.ScaleCheckBox.Checked;
            }
            
            this.DialogResult = DialogResult.OK;
            this.Close();
        }

        private void SaveAllInstancesDialog_Load(object sender, EventArgs e) {

        }
    }
}
